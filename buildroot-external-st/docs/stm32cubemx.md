# Use devicetree generated by STM32CubeMX

Applicable platforms: STM32MP157D-DK1, STM32MP157F-DK2, STM32MP135F-DK,
STM32MP257F-EV1, STM32MP257F-DK, STM32MP215F-DK.

The [STM32CubeMX
tool](https://www.st.com/en/development-tools/stm32cubemx.html
"STM32CubeMX tool") allows you to automatize the generation of
devicetrees with an easy to use interface. You can configure the state
of each pin of the STM32MPU component from the pinout view. The tool
generates Device Tree files for Linux, U-Boot, Arm-Trusted-Firmware (TF-A)
and OPTEE-OS. The STM32CubeMX version has to match the version of the ST
BSP components (TF-A, Linux, U-boot, OP-TEE OS).

All our *demo* configurations in ``buildroot-external-st`` use Device
Tree files generated by STM32CubeMX.

For the example in STM32CubeMX, create a test project, select the
STM32MP157F DK2 board and click on "generate code". Then you will find
in the test project directory the generated Device Tree for the Linux
kernel, TF-A and U-Boot:

```
CA7/DeviceTree/test/kernel:
stm32mp157f-mx.dts

CA7/DeviceTree/test/tf-a:
stm32mp157f-mx.dts  stm32mp157f-mx-fw-config.dts  stm32mp15-mx.dtsi

CA7/DeviceTree/test/u-boot:
stm32mp157f-mx.dts  stm32mp157f-mx-u-boot.dtsi  stm32mp15-mx.dtsi

CA7/DeviceTree/test/optee-os:
stm32mp157f-mx.dts
```

The generated Device Tree files can then be copied in the
*BR2_EXTERNAL* tree. Here we have chosen to create three folders named
*kernel-dts*, *uboot-dts* and *tfa-dts* where we put the dedicated
Device Tree files:

```
$ cp -a ${STM32CubeMX_output}/CA7/DeviceTree/test/kernel/* ${buildroot_external}/board/stmicroelectronics/stm32mp1/kernel-dts/st/
$ cp -a ${STM32CubeMX_output}/CA7/DeviceTree/test/u-boot/* ${buildroot_external}/board/stmicroelectronics/stm32mp1/uboot-dts
$ cp -a ${STM32CubeMX_output}/CA7/DeviceTree/test/tf-a/* ${buildroot_external}/board/stmicroelectronics/stm32mp1/tfa-dts
$ cp -a ${STM32CubeMX_output}/CA7/DeviceTree/test/optee-os/* ${buildroot_external}/board/stmicroelectronics/stm32mp1/optee-dts
```

The same has been done for all STM32MP1 platforms to generate the
different Device Tree files.

To use these Device Tree files in Buildroot you need to change the
Buildroot configuration by updating the Device Tree name and the
`BR2_*_CUSTOM_DTS_PATH` configurations (following the paths chosen),
for the OPTEE-OS, U-Boot and TF-A and `BR2_LINUX_KERNEL_CUSTOM_DTS_DIR`
for Linux. For example:

```
BR2_LINUX_KERNEL_INTREE_DTS_NAME="st/stm32mp157f-dk2-mx"
BR2_LINUX_KERNEL_CUSTOM_DTS_DIR="$(BR2_EXTERNAL_ST_PATH)/board/stmicroelectronics/stm32mp1/linux-dts"
BR2_TARGET_ARM_TRUSTED_FIRMWARE_CUSTOM_DTS_PATH="$(BR2_EXTERNAL_ST_PATH)/board/stmicroelectronics/stm32mp1/tfa-dts/*
BR2_TARGET_ARM_TRUSTED_FIRMWARE_ADDITIONAL_VARIABLES="STM32MP_SDMMC=1 AARCH32_SP=optee DTB_FILE_NAME=stm32mp157f-dk2-mx.dtb BL33_CFG=$(BINARIES_DIR)/u-boot.dtb"
BR2_TARGET_UBOOT_CUSTOM_DTS_PATH="$(BR2_EXTERNAL_ST_PATH)/board/stmicroelectronics/stm32mp1/uboot-dts/*"
BR2_TARGET_UBOOT_CUSTOM_MAKEOPTS="dtb-y=stm32mp157f-dk2-mx.dtb DEVICE_TREE=stm32mp157f-dk2-mx"
BR2_TARGET_OPTEE_OS_CUSTOM_DTS_PATH="$(BR2_EXTERNAL_ST_PATH)/board/stmicroelectronics/stm32mp1/optee-dts/*"
BR2_TARGET_OPTEE_OS_ADDITIONAL_VARIABLES="CFG_EMBED_DTB_SOURCE_FILE=stm32mp157f-dk2-mx.dts CFG_STM32MP15=y"
```

The option `dtb-y=stm32mp157f-dk2-mx.dtb` has been added to U-Boot
make options to build the external Device Tree file. Same goes with
`CFG_EMBED_DTB_SOURCE_FILE=stm32mp157f-dk2-mx.dts CFG_STM32MP15=y` for
OPTEE-OS.

You might need to modify the post-image.sh script to use a different
naming of the TF-A binary.

If Cube MX does not generated the devicetree as expected you can manually
verify the content of them with the help of the
[Wiki from ST](https://wiki.st.com/stm32mpu/wiki/Category:Platform_configuration
"ST Wiki").

You can then add you own board specific devicetree configuration inside the
comment.
```
/* USER CODE BEGIN .. */
...
/* USER CODE END .. */
```

Even if you generate the devicetree again, the code inside these comment
won't change.

---

Note: the default Device Tree generated by STM32MPCubeMX have few issues.
Please look at commits
979b467 ("board/st/dts: Few fixes in CubeMX MP1 generated devicetrees")
and 7218f37 ("board/st/dts: Few fixes in CubeMX MP2 generated devicetrees")
which list and fix them.

Note: CubeMX spit a warning pop up about wrong MDF1, RCC and TAMP value on
MP2 boards. It is a false positive and should not be taken into account.
